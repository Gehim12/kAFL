<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Github Actions CI/CD" href="../how_to/github_actions.html" /><link rel="prev" title="Installation" href="installation.html" />

    <!-- Generated with Sphinx 6.2.1 and Furo 2023.03.27 -->
        <title>Fuzzing the Linux Kernel - kAFL</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">kAFL</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">kAFL</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Fuzzing the Linux Kernel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how_to/github_actions.html">Github Actions CI/CD</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/fuzzer_configuration.html">Fuzzer Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/hypercall_api.html">kAFL/Nyx Hypercall API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/workdir_layout.html">kAFL Workdir</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/user_interface.html">kAFL User Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Context</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../context/research_papers.html">Research Papers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev/documentation.html">Building the documentation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/IntelLabs/kAFL/edit/docs/docs/source/tutorials/fuzzing_linux_kernel.md" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="fuzzing-the-linux-kernel">
<h1>Fuzzing the Linux Kernel<a class="headerlink" href="#fuzzing-the-linux-kernel" title="Permalink to this heading">#</a></h1>
<p>This example shows how to fuzz an OS kernel by implementing the kAFL agent
(harness) directly in the target.</p>
<p>This is useful for directly interfacing with low-level kernel interfaces,
or fuzzing during bootstrapping when no userspace is available.</p>
<p>It also has the benefit of not requiring any additional guest filesystem
setup or cross-compiling, as the harness is implemented directly in the kernel.</p>
<p>Instead of a silly hello world function, this example uses an existing kAFL
agent implemented for TDX guest kernel validation. We can enable an option to
perform input injection in the PCI MMIO/PIO reads, which will result in
interesting crashes when fuzzing PCI and VIRTIO initialization.</p>
<section id="download-patched-linux-kernel-or-port-to-your-preferred-kernel">
<h2>1. Download patched Linux kernel (or port to your preferred kernel)<a class="headerlink" href="#download-patched-linux-kernel-or-port-to-your-preferred-kernel" title="Permalink to this heading">#</a></h2>
<p>This kernel branch implements a kAFL agent in arch/x86/kernel/. It offers
multiple options for input injection and a state machine to enable/disable
fuzzing at various points during kernel execution.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$EXAMPLES_ROOT</span>/linux-kernel/
git clone -b kafl/fuzz-5.15-4 https://github.com/IntelLabs/kafl.linux.git --depth<span class="o">=</span><span class="m">1</span> linux-guest
</pre></div>
</div>
</section>
<section id="configure-and-build-target-kernel">
<h2>2. Configure and build target kernel<a class="headerlink" href="#configure-and-build-target-kernel" title="Permalink to this heading">#</a></h2>
<p>Install build dependencies (depends on kernel .config):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo apt install gawk bison flex openssl libssl-dev libelf-dev lz4 dwarves
</pre></div>
</div>
<p>Use the provided example config to build a guest kernel with PCI/VIRTIO fuzzing
enabled:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cp config.vanilla.virtio linux-guest/.config
make -C linux-guest -j<span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
</section>
<section id="start-fuzzing">
<h2>3. Start fuzzing!<a class="headerlink" href="#start-fuzzing" title="Permalink to this heading">#</a></h2>
<p>Since the harness is built-in and auto-snapshots on first fuzzing input,
launching the fuzzer is as simple as booting the kernel:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
Local setup</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">KAFL_CONFIG_FILE</span><span class="o">=</span>./kafl_config.yaml kafl fuzz --purge <span class="se">\</span>
	--redqueen --grimoire -D --radamsa <span class="se">\</span>
	--kernel linux-guest/arch/x86/boot/bzImage <span class="se">\</span>
	-t <span class="m">0</span>.1 -ts <span class="m">0</span>.01 -m <span class="m">512</span> --log-crashes -p <span class="m">2</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Docker image</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># we need to ensure the workdir is created before mounting it as a volume</span>
mkdir -p /dev/shm/kafl_<span class="k">$(</span>id -un<span class="k">)</span>
<span class="c1"># run kafl as Docker image</span>
docker run <span class="se">\</span>
        -ti --rm <span class="se">\</span>
        --device /dev/kvm <span class="se">\</span>
        -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/kafl_config.yaml:/mnt/kafl_config.yaml <span class="se">\</span>
        -v /dev/shm/kafl_<span class="k">$(</span>id -un<span class="k">)</span>:/mnt/workdir <span class="se">\</span>
        -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/linux-guest/arch/x86/boot/bzImage:/mnt/kernel <span class="se">\</span>
        -e <span class="nv">KAFL_CONFIG_FILE</span><span class="o">=</span>/mnt/kafl_config.yaml <span class="se">\</span>
        --user <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="se">\</span>
        --group-add <span class="k">$(</span>getent group kvm <span class="p">|</span> cut -d: -f3<span class="k">)</span> <span class="se">\</span>
        intellabs/kafl <span class="se">\</span>
        fuzz <span class="se">\</span>
        --purge <span class="se">\</span>
        -w /mnt/workdir <span class="se">\</span>
        --redqueen --grimoire -D --radamsa <span class="se">\</span>
        --kernel /mnt/kernel <span class="se">\</span>
        -t <span class="m">0</span>.1 -ts <span class="m">0</span>.01 -m <span class="m">512</span> --log-crashes -p <span class="m">2</span>
</pre></div>
</div>
</div>
</div>
<p>Expected output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    __                        __  ___    ________
   / /_____  _________  ___  / / /   |  / ____/ /
  / //_/ _ \/ ___/ __ \/ _ \/ / / /| | / /_  / /
 / ,&lt; /  __/ /  / / / /  __/ / / ___ |/ __/ / /___
/_/|_|\___/_/  /_/ /_/\___/_/ /_/  |_/_/   /_____/
===================================================

&lt;&lt; kAFL Fuzzer &gt;&gt;

Warning: Launching without -seed_dir?
No PT trace region defined.
00:00:00:     0 exec/s,    0 edges,  0% favs pending, findings: &lt;0, 0, 0&gt;
Worker-00 Launching virtual machine...
/home/user/work/kafl/nyx/qemu/x86_64-softmmu/qemu-system-x86_64
        -enable-kvm
        -machine kAFL64-v1
        -cpu kAFL64-Hypervisor-v1,+vmx
        -no-reboot
        -display none
        -netdev user,id=mynet0
        -device virtio-net,netdev=mynet0
        -chardev socket,server,nowait,id=nyx_socket,path=/dev/shm/kafl/interface_0
        -device nyx,chardev=nyx_socket,workdir=/dev/shm/kafl,worker_id=0,bitmap_size=65536,input_buffer_size=131072
        -device isa-serial,chardev=kafl_serial
        -chardev file,id=kafl_serial,mux=on,path=/dev/shm/kafl/serial_00.log
        -m 512
        -kernel /home/user/work/examples/linux-kernel/linux-guest/arch/x86/boot/bzImage
        -append root=/dev/vda1 rw hprintf=4 nokaslr oops=panic nopti mitigations=off
        -fast_vm_reload path=/dev/shm/kafl/snapshot/,load=off
Worker-01 Launching virtual machine...
Invalid sharedir...
[QEMU-Nyx] Booting VM to start fuzzing...
Invalid sharedir...
[!] qemu-nyx: waiting for snapshot to start fuzzing...
WARNING: ATTEMPTING FAST GET for virtio
Worker-00 entering fuzz loop..
00:00:02: Got    1 from    0: exit=R, 5637/ 0 bits, 5637 favs, 4.56msec, 0.2KB (kickstart)
00:00:02: Got    2 from    0: exit=R, 261/605 bits, 743 favs, 5.55msec, 0.2KB (kickstart)
00:00:02: Got    3 from    0: exit=R, 2298/2785 bits, 2298 favs, 21.20msec, 0.2KB (kickstart)
00:00:02: Got    4 from    0: exit=R, 20/576 bits, 35 favs, 17.62msec, 0.2KB (kickstart)
00:00:02: Got    5 from    0: exit=R, 32/644 bits, 2072 favs, 11.99msec, 0.2KB (kickstart)
00:00:03: Got    6 from    0: exit=R,  0/14 bits,  0 favs, 15.52msec, 0.2KB (kickstart)
00:00:03: Got    7 from    0: exit=R,  0/ 5 bits,  0 favs, 19.62msec, 0.2KB (kickstart)
00:00:03: Got    8 from    0: exit=R,  0/ 3 bits,  0 favs, 4.49msec, 0.2KB (kickstart)
00:00:03: Got    9 from    0: exit=R,  0/ 1 bits,  0 favs, 12.25msec, 0.2KB (kickstart)
Worker-01 entering fuzz loop..
00:00:03: Got   10 from    0: exit=R, 42/3502 bits, 42 favs, 36.80msec, 0.2KB (kickstart)
00:00:03: Got   11 from    5: exit=K, 8667/ 0 bits,  0 favs, 98.15msec, 0.2KB (calibrate)
00:00:03: Got   12 from    0: exit=R,  5/1516 bits, 796 favs, 14.27msec, 0.2KB (kickstart)
00:00:03: Got   13 from    5: exit=R,  0/21 bits,  0 favs, 12.19msec, 0.2KB (calibrate)
00:00:03: Got   14 from    0: exit=R,  0/12 bits,  0 favs, 19.61msec, 0.2KB (kickstart)
00:00:03: Got   15 from    5: exit=R,  4/636 bits, 1132 favs, 6.54msec, 0.0KB (trim)
00:00:03: Got   16 from    5: exit=R,  0/272 bits,  0 favs, 2.50msec, 0.0KB (trim)
00:00:03: Got   17 from    5: exit=R,  0/79 bits,  0 favs, 0.26msec, 0.0KB (trim)
00:00:03: Got   18 from    5: exit=R,  0/395 bits,  0 favs, 4.81msec, 0.0KB (trim)
00:00:03: Got   19 from    5: exit=R,  0/247 bits,  0 favs, 8.41msec, 0.0KB (trim)
00:00:03: Got   20 from    5: exit=R,  0/670 bits,  0 favs, 4.44msec, 0.0KB (trim)
00:00:03: Got   21 from    0: exit=R,  0/ 4 bits,  0 favs, 14.56msec, 0.2KB (kickstart)
00:00:03: Got   22 from    5: exit=R,  0/ 1 bits,  0 favs, 14.25msec, 0.1KB (trim_center)
[...]
</pre></div>
</div>
</section>
<section id="gui">
<h2>4. GUI<a class="headerlink" href="#gui" title="Permalink to this heading">#</a></h2>
<p>KAFL has a graphical text-based interface that can be displayed with:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-2" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
Local setup</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kafl gui <span class="o">[</span>-w <span class="nv">$KAFL_WORKDIR</span><span class="o">]</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-3" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-3">
Docker image</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker run <span class="se">\</span>
        -ti --rm <span class="se">\</span>
        -v /dev/shm/kafl_<span class="k">$(</span>id -un<span class="k">)</span>:/mnt/workdir <span class="se">\</span>
        --user <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="se">\</span>
        --group-add <span class="k">$(</span>getent group kvm <span class="p">|</span> cut -d: -f3<span class="k">)</span> <span class="se">\</span>
        intellabs/kafl <span class="se">\</span>
        gui <span class="se">\</span>
        -w /mnt/workdir
</pre></div>
</div>
</div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ls <span class="nv">$KAFL_WORKDIR</span>/corpus/
ls <span class="nv">$KAFL_WORKDIR</span>/logs/
</pre></div>
</div>
</section>
<section id="coverage">
<h2>5. Coverage<a class="headerlink" href="#coverage" title="Permalink to this heading">#</a></h2>
<p>For coverage reports, we need to first find out what PT filter ranges are used for the kernel image.
They are auto-detected on startup and can be logged using <code class="docutils literal notranslate"><span class="pre">--log-hprintf</span></code> parameter.</p>
<p>Try to launch with <code class="docutils literal notranslate"><span class="pre">--log-hprintf</span> <span class="pre">-p</span> <span class="pre">1</span></code> instead of the above <code class="docutils literal notranslate"><span class="pre">--log-crashes</span></code> and look at <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/hprintf_00.log</span></code>.</p>
<p>Sample content for <code class="docutils literal notranslate"><span class="pre">KAFL_WORKDIR/hprintf_00.log</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">Submitting</span> <span class="n">payload</span> <span class="n">buffer</span> <span class="n">address</span> <span class="n">to</span> <span class="n">hypervisor</span> <span class="p">(</span><span class="n">ffffffff859ad000</span><span class="p">)</span>
<span class="n">Setting</span> <span class="nb">range</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ffffffff81000000</span><span class="o">-</span><span class="n">ffffffff83603000</span>
<span class="n">Setting</span> <span class="nb">range</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ffffffff855ed000</span><span class="o">-</span><span class="n">ffffffff856e4000</span>
<span class="n">Starting</span> <span class="n">kAFL</span> <span class="n">loop</span><span class="o">...</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Lets extract these IP ranges, and export them in environment variables:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">IP0</span><span class="o">=</span><span class="k">$(</span>grep -oP <span class="s1">&#39;Setting range 0:\s+\K.*-.*&#39;</span> <span class="nv">$KAFL_WORKDIR</span>/hprintf_00.log<span class="k">)</span>
<span class="nb">export</span> <span class="nv">IP1</span><span class="o">=</span><span class="k">$(</span>grep -oP <span class="s1">&#39;Setting range 1:\s+\K.*-.*&#39;</span> <span class="nv">$KAFL_WORKDIR</span>/hprintf_00.log<span class="k">)</span>
</pre></div>
</div>
<p>Then use <code class="docutils literal notranslate"><span class="pre">kafl</span> <span class="pre">cov</span></code> subcommand with <code class="docutils literal notranslate"><span class="pre">--resume</span></code> will reload the guest state directly from the Nyx fast-snapshot used during fuzzing and re-use the existing <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/page_cache*</span></code> files, leading to better reproducibility.</p>
<p>PT traces produced by Qemu/worker instances are
picked up from <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/pt_trace_dump_NN</span></code> and stored at <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/traces/*bin.lz4</span></code>.
The <code class="docutils literal notranslate"><span class="pre">kafl</span> <span class="pre">cov</span></code> tool then calls <code class="docutils literal notranslate"><span class="pre">ptdump</span></code> with the given PT filter range and
<code class="docutils literal notranslate"><span class="pre">page_cache</span></code> files to decode to a corresponding text file <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/traces/*.txt.lz4</span></code>.</p>
<p>For best results, it is recommended to collect binary PT traces already during
fuzzing (using <code class="docutils literal notranslate"><span class="pre">kafl</span> <span class="pre">fuzz</span> <span class="pre">--trace</span></code> option). The <code class="docutils literal notranslate"><span class="pre">kafl</span> <span class="pre">cov</span></code> tool will detect the
existing binary traces in <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/traces/</span></code> and skip re-executing the corpus,
providing accurate coverage traces even for non-deterministic targets.</p>
<p>For big corpuses, you can parallelize this process using <code class="docutils literal notranslate"><span class="pre">-p</span></code>:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-4" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-4">
Local setup</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">KAFL_CONFIG_FILE</span><span class="o">=</span>kafl_config.yaml kafl cov <span class="se">\</span>
	--kernel linux-guest/arch/x86/boot/bzImage <span class="se">\</span>
	-ip0 <span class="nv">$IP0</span> <span class="se">\</span>
	-ip1 <span class="nv">$IP1</span> <span class="se">\</span>
	--resume -m <span class="m">512</span> -t <span class="m">2</span> -p <span class="m">24</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-5" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-5">
Docker image</label><div class="sd-tab-content docutils">
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker run <span class="se">\</span>
        -ti --rm <span class="se">\</span>
        --device /dev/kvm <span class="se">\</span>
        -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/kafl_config.yaml:/mnt/kafl_config.yaml <span class="se">\</span>
        -v /dev/shm/kafl_<span class="k">$(</span>id -un<span class="k">)</span>:/mnt/workdir <span class="se">\</span>
        -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/linux-guest/arch/x86/boot/bzImage:/mnt/kernel <span class="se">\</span>
        -e <span class="nv">KAFL_CONFIG_FILE</span><span class="o">=</span>/mnt/kafl_config.yaml <span class="se">\</span>
        --user <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="se">\</span>
        --group-add <span class="k">$(</span>getent group kvm <span class="p">|</span> cut -d: -f3<span class="k">)</span> <span class="se">\</span>
        intellabs/kafl <span class="se">\</span>
        cov <span class="se">\</span>
        -w /mnt/workdir <span class="se">\</span>
        --input /mnt/workdir <span class="se">\</span>
        --kernel /mnt/kernel <span class="se">\</span>
        -ip0 <span class="nv">$IP0</span> <span class="se">\</span>
        -ip1 <span class="nv">$IP1</span> <span class="se">\</span>
        --resume -m <span class="m">512</span> -t <span class="m">2</span> -p <span class="m">24</span>
</pre></div>
</div>
</div>
</div>
<p>Note that timeout and VM settings are not relevant here anymore, but the tool will
complain about invalid/missing options. Based on the binary PT dumps,
IP ranges and the code image retained in <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/page_cache</span></code>, this simply uses the
libxdc <code class="docutils literal notranslate"><span class="pre">ptdump</span></code> to decode <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/traces/*bin.lz4</span></code> to <code class="docutils literal notranslate"><span class="pre">$KAFL_WORKDIR/traces/*.txt.lz4</span></code>.</p>
</section>
<section id="next-steps">
<h2>6. Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this heading">#</a></h2>
<p>Look at the kernel source code and in particular at the implementation of the
different harness and input injection options defined in .config.</p>
<p>Be sure to read other documentation to understand the various options and
interpreting fuzzer outputs.</p>
</section>
<section id="known-issues">
<h2>7) Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><em>[ERROR] Guest ABORT: Attempt to finish kAFL run but never initialized</em> - This
happens when the configured harness does not consume any inputs. For instance
when fuzzing PCI initialization functions without activating MMIO/PIO input
injection. Also, initialization phases may depend on each other, for instance,
fuzzing virtio-net initialization may be a no-op if previously performed PCI
scan did not detect any virtio-net devices. It helps to enable virtio-net in
Qemu.</p></li>
<li><p><em>libxdc_decode_error</em> - This mainly happens on invalid or missing PT filter
settings.  Alternatively, decoding PT traces can fail with new/unsupported
instructions (check libcapstone for updates) or in case of dynamic code rewrite.
The provided example kernel has minor patches/options set to avoid dynamic code
rewrite (see Linux ‘alternative instructions’, dynamic ftrace, jump label etc.)</p></li>
<li><p><em>qemu-system-x86_64: assertion error xyz</em> - Especially during virtio fuzzing,
the guest may do unexpected things to the host virtio emulation that can cause
Qemu to crash or leak memory. In most cases it is sufficient to disable the
assert.</p></li>
</ol>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../how_to/github_actions.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Github Actions CI/CD</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="installation.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Installation</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Steffen Schulz - Mathieu Tarral
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/IntelLabs/kAFL" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Fuzzing the Linux Kernel</a><ul>
<li><a class="reference internal" href="#download-patched-linux-kernel-or-port-to-your-preferred-kernel">1. Download patched Linux kernel (or port to your preferred kernel)</a></li>
<li><a class="reference internal" href="#configure-and-build-target-kernel">2. Configure and build target kernel</a></li>
<li><a class="reference internal" href="#start-fuzzing">3. Start fuzzing!</a></li>
<li><a class="reference internal" href="#gui">4. GUI</a></li>
<li><a class="reference internal" href="#coverage">5. Coverage</a></li>
<li><a class="reference internal" href="#next-steps">6. Next Steps</a></li>
<li><a class="reference internal" href="#known-issues">7) Known Issues</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    </body>
</html>